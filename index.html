<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>.NET NativeAOT-LLVM + SDL3 + WebGPU Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #1a1a2e;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #eee;
        }

        h1 {
            margin-bottom: 20px;
            font-weight: 300;
            color: #fff;
        }

        .subtitle {
            margin-bottom: 20px;
            color: #888;
            font-size: 14px;
        }

        #canvas-container {
            border: 2px solid #4a4a6a;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        #canvas {
            display: block;
            width: 800px;
            height: 600px;
        }

        #status {
            margin-top: 20px;
            padding: 10px 20px;
            background: #2a2a4a;
            border-radius: 4px;
            font-size: 14px;
        }

        #console {
            margin-top: 20px;
            width: 800px;
            max-height: 200px;
            overflow-y: auto;
            background: #0a0a1a;
            border: 1px solid #3a3a5a;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 12px;
            color: #0f0;
        }

        #console .log { color: #0f0; }
        #console .error { color: #f55; }
        #console .warn { color: #ff0; }

        .controls {
            margin-top: 15px;
            font-size: 14px;
            color: #888;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #444;
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <h1>.NET NativeAOT-LLVM WebGPU Demo</h1>
    <p class="subtitle">SDL3 + WebGPU with Dawn bindings</p>

    <div id="canvas-container">
        <canvas id="canvas" width="800" height="600"></canvas>
    </div>

    <div id="status" class="loading">
        <div class="spinner"></div>
        <span>Loading WebAssembly module...</span>
    </div>

    <div class="controls">
        Controls: <strong>Space</strong> = Reset color | <strong>Click</strong> = Brighten background | <strong>ESC</strong> = Quit
    </div>

    <div id="console"></div>

    <script type="module">
        // Console output capture
        const consoleDiv = document.getElementById('console');
        const maxLogLines = 100;

        function addConsoleLine(text, type = 'log') {
            const line = document.createElement('div');
            line.className = type;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
            consoleDiv.appendChild(line);

            // Limit log lines
            while (consoleDiv.childNodes.length > maxLogLines) {
                consoleDiv.removeChild(consoleDiv.firstChild);
            }

            // Auto-scroll to bottom
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        // Override console methods
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            originalLog.apply(console, args);
            addConsoleLine(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addConsoleLine(args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addConsoleLine(args.join(' '), 'warn');
        };

        // Check WebGPU support
        async function checkWebGPUSupport() {
            if (!navigator.gpu) {
                throw new Error('WebGPU is not supported in this browser. Please use Chrome 113+, Edge 113+, or another WebGPU-enabled browser.');
            }

            const adapter = await navigator.gpu.requestAdapter();
            if (!adapter) {
                throw new Error('Failed to get WebGPU adapter. Your GPU may not be supported.');
            }

            console.log('WebGPU is available!');
            return true;
        }

        // Status update helper
        function setStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = message;
            statusDiv.classList.remove('loading');
            if (isError) {
                statusDiv.style.color = '#f55';
            } else {
                statusDiv.style.color = '#0f0';
            }
        }

        // Main initialization
        async function main() {
            try {
                // Check WebGPU support first
                await checkWebGPUSupport();

                setStatus('Loading WebAssembly module...');

                // Import the ES6 module (NativeAOT-LLVM with -sEXPORT_ES6=1 -sMODULARIZE=1)
                console.log('[JS] Importing WASM module...');
                const { default: Module } = await import('./DotNetWasmDemo.js');
                console.log('[JS] WASM module imported, calling Module()...');

                // Initialize the module with canvas configuration
                // NOTE: Don't await Module() - emscripten_set_main_loop with simulate_infinite_loop=1
                // never returns, so the Promise never resolves. This is expected behavior.
                Module({
                    canvas: document.getElementById('canvas'),
                    print: (text) => console.log(text),
                    printErr: (text) => console.error(text),
                    onRuntimeInitialized: () => {
                        console.log('[JS] onRuntimeInitialized callback fired');
                        setStatus('Application running');
                    },
                    onAbort: (what) => {
                        console.error('[JS] Module aborted:', what);
                        setStatus(`Aborted: ${what}`, true);
                    }
                }).catch(err => {
                    // This catch handles the "unwind" exception that emscripten_set_main_loop throws
                    // It's expected behavior, not an error
                    if (err !== 'unwind') {
                        console.error('[JS] Module error:', err);
                        setStatus(`Error: ${err}`, true);
                    }
                });

                console.log('[JS] Module() called (not awaiting - main loop takes over)');

            } catch (error) {
                console.error('Failed to initialize:', error);
                setStatus(`Error: ${error.message}`, true);
            }
        }

        // Start when the page loads
        main();
    </script>
</body>
</html>
