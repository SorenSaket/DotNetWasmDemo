name: Build WASM

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET 10
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        dotnet-quality: 'preview'
    
    - name: Setup Emscripten
      # NativeAOT-LLVM requires Emscripten 3.1.56 - do not change without verifying compatibility
      # See: https://github.com/dotnet/runtimelab/blob/feature/NativeAOT-LLVM/eng/pipelines/runtimelab/install-emscripten.ps1
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: '3.1.56'
        actions-cache-folder: 'emsdk-cache'
    
    - name: Verify Emscripten
      run: emcc --version
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build and Publish
      run: dotnet publish -r browser-wasm -c Release

    - name: Fix Module.HEAP32 exports
      # NativeAOT-LLVM generates code that expects Module.HEAP32 but Emscripten doesn't expose it
      # This patches the generated JS to export HEAP arrays on the Module object
      run: node scripts/fix-heap-exports.js

    - name: Upload WASM artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wasm-output
        path: bin/Release/net10.0/browser-wasm/publish/
        retention-days: 30

  # Optional: Deploy to GitHub Pages
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: wasm-output
        path: ./publish
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload to Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./publish
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
