name: Build and Deploy WASM

on:
  push:
    branches: ['*']  # Trigger on all branches
  pull_request:
    branches: ['*']  # Trigger on PRs to any branch
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET 10
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        dotnet-quality: 'preview'

    - name: Setup Emscripten
      # Using latest Emscripten for SDL3 and emdawnwebgpu support
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: 'latest'
        actions-cache-folder: 'emsdk-cache'

    - name: Verify Emscripten
      run: emcc --version

    - name: Restore dependencies
      run: dotnet restore

    - name: Build and Publish
      run: dotnet publish -r browser-wasm -c Release

    - name: Fix Module.HEAP32 exports
      # NativeAOT-LLVM generates code that expects Module.HEAP32 but Emscripten doesn't expose it
      run: node scripts/fix-heap-exports.js

    - name: Upload WASM artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wasm-output
        path: bin/Release/net10.0/browser-wasm/publish/
        retention-days: 30

  # Deploy to GitHub Pages (only on main/master branch)
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: wasm-output
        path: ./publish

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload to Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./publish

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
